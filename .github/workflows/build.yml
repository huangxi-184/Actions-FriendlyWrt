name: Build FriendlyWrt for rk3566 (24.10 non-docker)

on:
  watch:
    types: started

jobs:
  prepare_release:
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
      - name: Get release tag
        id: release_tag
        run: |
          release_tag="FriendlyWrt-$(date +%Y-%m-%d)"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT

      - name: Create empty release
        id: release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_tag.outputs.release_tag }}
          draft: false
          prerelease: false
    outputs:
      release_tag: ${{ steps.release_tag.outputs.release_tag }}
      upload_url: ${{ steps.release.outputs.upload_url }}

  build_friendlywrt:
    needs: prepare_release
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d
          sudo apt-get update
          sudo apt-get install -y wget git python2.7
          wget https://raw.githubusercontent.com/friendlyarm/build-env-on-ubuntu-bionic/master/install.sh
          sed -i -e 's/^apt-get -y install openjdk-8-jdk/# &/g' install.sh
          sed -i -e 's/^$$ -d fa-toolchain $$/# &/g' install.sh
          sed -i -e 's/^(cat fa-toolchain/# &/g' install.sh
          sed -i -e 's/^(tar xf fa-toolchain/# &/g' install.sh
          sudo -E bash ./install.sh
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 20
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'noreply@github.com'
          git clone https://github.com/friendlyarm/repo
          sudo cp repo/repo /usr/bin/
          mkdir -p ./artifact
          sudo swapoff -a
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk /usr/local/share/boost /opt/ghc

      - name: Download source
        run: |
          mkdir project
          cd project
          repo init --depth=1 -u https://github.com/friendlyarm/friendlywrt_manifests -b master-v24.10 \
                  -m rk3566.xml --repo-url=https://github.com/friendlyarm/repo --no-clone-bundle
          repo sync -c --no-clone-bundle

      - name: Apply customizations
        run: |
          cd project
          [ -f ../scripts/add_packages.sh ] && source ../scripts/add_packages.sh
          [ -f ../scripts/custome_config.sh ] && source ../scripts/custome_config.sh

      - name: Prepare config
        run: |
          cd project
          cat > .current_config.mk <<EOL
          . device/friendlyelec/rk3566/base.mk
          TARGET_IMAGE_DIRNAME=friendlywrt24
          TARGET_FRIENDLYWRT_CONFIG=rockchip
          EOL
          DEBUG_DOT_CONFIG=1 ./build.sh friendlywrt

      - name: Download package
        run: |
          cd project/friendlywrt
          make download -j$(nproc)
          find dl -size -1024c -delete

      - name: Compile friendlyWrt
        id: compile
        continue-on-error: true
        run: |
          cd project/friendlywrt
          make -j$(nproc) || make -j1 V=s

      - name: Create rootfs package
        id: create_rootfs_package
        run: |
          cd project
          source .current_config.mk
          rootfs_filename="rootfs-friendlywrt-24.10.tgz"
          tar cvzf ../artifact/${rootfs_filename} ${FRIENDLYWRT_SRC}/${FRIENDLYWRT_ROOTFS} \
                ${FRIENDLYWRT_SRC}/${FRIENDLYWRT_PACKAGE_DIR}
          echo "rootfs_filename=$rootfs_filename" >> $GITHUB_OUTPUT

      - name: Upload rootfs package
        uses: softprops/action-gh-release@v1
        with:
          files: ./artifact/${{ steps.create_rootfs_package.outputs.rootfs_filename }}
          tag_name: ${{ needs.prepare_release.outputs.release_tag }}

  build_img:
    needs: [prepare_release, build_friendlywrt]
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y wget git python2.7
          git clone https://github.com/friendlyarm/repo
          sudo cp repo/repo /usr/bin/
          mkdir -p ./artifact

      - name: Download source
        run: |
          mkdir project
          cd project
          repo init --depth=1 -u https://github.com/friendlyarm/friendlywrt_manifests -b master-v24.10 \
                  -m rk3566.xml --repo-url=https://github.com/friendlyarm/repo --no-clone-bundle
          repo sync -c --no-clone-bundle

      - name: Download rootfs
        uses: actions/download-artifact@v3
        with:
          name: rootfs-friendlywrt-24.10.tgz

      - name: Prepare config
        id: config
        run: |
          cd project
          cat > .current_config.mk <<EOL
          . device/friendlyelec/rk3566/base.mk
          TARGET_IMAGE_DIRNAME=friendlywrt24
          TARGET_FRIENDLYWRT_CONFIG=rockchip
          TARGET_SD_RAW_FILENAME=R3S-Series-FriendlyWrt-24.10.img
          EOL
          echo "img_filename=R3S-Series-FriendlyWrt-24.10.img" >> $GITHUB_OUTPUT

      - name: Unpack rootfs
        run: |
          cd project
          tar xvzf ../rootfs-friendlywrt-24.10.tgz

      - name: Compile uboot and kernel
        run: |
          cd project
          ./build.sh uboot
          ./build.sh kernel

      - name: Build image
        run: |
          cd project
          ./build.sh sd-img
          mv out/${{ steps.config.outputs.img_filename }} ../artifact/
          cd ../artifact/
          gzip ${{ steps.config.outputs.img_filename }}

      - name: Upload image
        uses: softprops/action-gh-release@v1
        with:
          files: ./artifact/${{ steps.config.outputs.img_filename }}.gz
          tag_name: ${{ needs.prepare_release.outputs.release_tag }}
